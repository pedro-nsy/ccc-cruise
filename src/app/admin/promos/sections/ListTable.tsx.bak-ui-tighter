import { Info, ChevronUp, ChevronDown } from "lucide-react";
import { usePathname, useRouter, useSearchParams } from "next/navigation";
import { TypeChip, StatusChip } from "./chips";

type SortKey = "created" | "code" | "type" | "status" | "assigned";

export default function ListTable({
  items,
  loading,
  onCopy,
  onToggleStatus,
  onOpenDetails,
  total,
}: {
  items: Array<{
    id: string | number;
    code: string;
    type: "early_bird" | "artist" | "staff";
    status: "active" | "archived" | "reserved" | "consumed";
    used_count: number;
    assigned_to_name: string | null;
    created_at?: string;
  }>;
  loading: boolean;
  onCopy: (code: string) => void;
  onToggleStatus: (id: string | number, to: "active" | "archived") => void;
  onOpenDetails: (row: any) => void;
  total: number;
}) {
  const router = useRouter();
  const pathname = usePathname();
  const sp = useSearchParams();

  const page = Math.max(1, parseInt(sp.get("page") ?? "1", 10));
  const limit = Math.max(1, parseInt(sp.get("limit") ?? "25", 10));
  const pages = Math.max(1, Math.ceil((total || 0) / limit));
  const sort: SortKey = ((sp.get("sort") as SortKey) || "created");
  const dir = (sp.get("dir") === "asc" ? "asc" : "desc");

  function setUrl(nextSort: SortKey) {
    const url = new URL(window.location.origin + pathname + "?" + sp.toString());
    const isSame = sort === nextSort;
    const nextDir = isSame ? (dir === "asc" ? "desc" : "asc") : "asc";
    url.searchParams.set("sort", nextSort);
    url.searchParams.set("dir", nextDir);
    url.searchParams.set("page", "1");
    router.replace(url.toString(), { scroll: false });
  }

  function setPage(next: number) {
    const url = new URL(window.location.origin + pathname + "?" + sp.toString());
    const n = Math.min(Math.max(1, next), pages);
    url.searchParams.set("page", String(n));
    router.replace(url.toString(), { scroll: false });
  }

  function Th({ label, col, className }: { label: string; col: SortKey; className?: string }) {
    const active = sort === col;
    return (
      <button
        type="button"
        onClick={(e) => { e.preventDefault(); e.stopPropagation(); setUrl(col); }}
        className={"w-full inline-flex items-center justify-center gap-1 hover:underline " + (className || "")}
        title={"Sort by " + label}
      >
        <span>{label}</span>
        {active ? (dir === "asc" ? <ChevronUp className="w-3 h-3" /> : <ChevronDown className="w-3 h-3" />) : null}
      </button>
    );
  }

  if (loading) {
    return (
      <section className="rounded-2xl border bg-white p-6">
        <div className="text-sm text-neutral-600">Loading…</div>
      </section>
    );
  }

  if (!items || items.length === 0) {
    return (
      <section className="rounded-2xl border bg-white p-6">
        <div className="rounded-xl border bg-neutral-50 p-4 text-sm">
          No codes match your filters. Try adjusting search or filters.
        </div>
      </section>
    );
  }

  return (
    <section className="rounded-2xl border bg-white p-6 text-sm text-neutral-700">
      {/* Header */}
      <div className="grid grid-cols-12 rounded-xl bg-neutral-50 border border-neutral-200 text-xs font-medium text-neutral-600">
        <div className="col-span-3 text-center px-3 py-1.5"><Th label="Code" col="code" /></div>
        <div className="col-span-2 text-center px-3 py-1.5"><Th label="Type" col="type" /></div>
        <div className="col-span-2 text-center px-3 py-1.5"><Th label="Status" col="status" /></div>
        <div className="hidden md:block md:col-span-3 text-center px-3 py-1.5"><Th label="Assigned" col="assigned" /></div>
        <div className="hidden md:block md:col-span-1 text-center px-3 py-1.5"><Th label="Created" col="created" /></div>
        <div className="col-span-3 md:col-span-1 text-center px-3 py-1.5">Actions</div>
      </div>

      {/* Rows */}
      <div className="divide-y">
        {items.map((p) => (
          <div key={String(p.id)} className="grid grid-cols-12 items-center py-1.5">
            {/* Code + Copy */}
            <div className="col-span-3 text-center px-3 py-1.5 font-mono font-semibold">
              <div className="inline-flex items-center gap-2">
                <span className="truncate">{p.code}</span>
                <button
                  type="button"
                  className="px-2 py-1 text-xs underline hover:no-underline focus:outline-none focus:ring-2 focus:ring-blue-200 rounded"
                  title="Copy code"
                  onClick={() => onCopy(p.code)}
                >
                  Copy
                </button>
              </div>
            </div>

            {/* Type */}
            <div className="col-span-2 text-center px-3 py-1.5"><TypeChip t={p.type} /></div>

            {/* Status */}
            <div className="col-span-2 text-center px-3 py-1.5"><StatusChip s={p.status} /></div>

            {/* Assigned (name only, hide on mobile) */}
            <div className="hidden md:flex md:col-span-3 items-center justify-center px-3 py-1.5 truncate">
              {p.assigned_to_name || "—"}
            </div>

            {/* Created (hide on mobile) */}
            <div className="hidden md:flex md:col-span-1 items-center justify-center px-3 py-1.5">
              {p.created_at
                ? new Date(p.created_at).toLocaleDateString(undefined, { month: "short", day: "numeric", year: "numeric" })
                : "—"}
            </div>

            {/* Actions */}
            <div className="col-span-3 md:col-span-1 flex items-center justify-center gap-2 px-3 py-1.5">
              {p.status === "consumed" ? (
                <button
                  type="button"
                  className="btn btn-ghost text-sm px-3 py-1.5 opacity-60 cursor-not-allowed no-underline hover:no-underline"
                  title="Consumed codes cannot be archived"
                  disabled
                >
                  Consumed
                </button>
              ) : p.status === "active" || p.status === "reserved" ? (
                <button
                  type="button"
                  className="btn btn-ghost text-sm px-3 py-1.5"
                  onClick={() => onToggleStatus(p.id, "archived")}
                >
                  Archive
                </button>
              ) : (
                <button
                  type="button"
                  className="btn btn-primary text-sm px-3 py-1.5"
                  onClick={() => onToggleStatus(p.id, "active")}
                >
                  Activate
                </button>
              )}

              <button
                type="button"
                className="btn btn-ghost inline-flex items-center justify-center p-2"
                title="Details"
                onClick={() => onOpenDetails(p)}
              >
                <Info className="w-4 h-4" />
              </button>
            </div>
          </div>
        ))}
      </div>

      {/* Pagination */}
      <div className="mt-4 flex items-center justify-between text-xs md:text-sm">
        <div className="text-neutral-600">Page {page} of {pages}</div>
        <div className="flex items-center gap-2">
          <button
            type="button"
            className="btn btn-ghost text-sm px-3 py-1.5"
            onClick={() => setPage(page - 1)}
            disabled={page <= 1}
          >
            Prev
          </button>
          <button
            type="button"
            className="btn btn-ghost text-sm px-3 py-1.5"
            onClick={() => setPage(page + 1)}
            disabled={page >= pages}
          >
            Next
          </button>
        </div>
      </div>
    </section>
  );
}
